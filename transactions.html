<!DOCTYPE html>

<html lang="en-us">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">

  <title>Transactions - Moor</title>
  <link rel="stylesheet" href="https://moor.simonbinder.eu/assets/css/just-the-docs.css">
  
  <script type="text/javascript" src="https://moor.simonbinder.eu/assets/js/vendor/lunr.min.js"></script>
  
  <script type="text/javascript" src="https://moor.simonbinder.eu/assets/js/just-the-docs.js"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>

  <div class="page-wrap">
    <div class="side-bar">
      <a href="https://moor.simonbinder.eu/" class="site-title fs-6 lh-tight">Moor</a>
      <span class="fs-3"><button class="js-main-nav-trigger navigation-list-toggle btn btn-outline" type="button" data-text-toggle="Hide">Menu</button></span>
      <div class="navigation main-nav js-main-nav">
        <nav role="navigation" aria-label="Main navigation">
  <ul class="navigation-list">
    
    
      
    
      
        
      
    
      
        
      
    
      
        
          <li class="navigation-list-item">
            
            <a href="https://moor.simonbinder.eu/" class="navigation-list-link">Home</a>
            
          </li>
        
      
    
      
        
          <li class="navigation-list-item">
            
            <a href="https://moor.simonbinder.eu/getting-started/" class="navigation-list-link">Getting started</a>
            
          </li>
        
      
    
      
        
          <li class="navigation-list-item">
            
            <a href="https://moor.simonbinder.eu/queries/" class="navigation-list-link">Writing queries</a>
            
              
              <ul class="navigation-list-child-list ">
                
                  
                
                  
                    <li class="navigation-list-item ">
                      
                      <a href="https://moor.simonbinder.eu/queries/custom" class="navigation-list-link">Custom queries</a>
                      
                    </li>
                  
                
                  
                    <li class="navigation-list-item ">
                      
                      <a href="https://moor.simonbinder.eu/queries/joins" class="navigation-list-link">Table joins</a>
                      
                    </li>
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
              </ul>
            
          </li>
        
      
    
      
        
          <li class="navigation-list-item active">
            
            <a href="https://moor.simonbinder.eu/transactions" class="navigation-list-link active">Transactions</a>
            
          </li>
        
      
    
      
        
          <li class="navigation-list-item">
            
            <a href="https://moor.simonbinder.eu/migrations/" class="navigation-list-link">Migrations</a>
            
          </li>
        
      
    
      
        
          <li class="navigation-list-item">
            
            <a href="https://moor.simonbinder.eu/daos/" class="navigation-list-link">Modularity with DAOs</a>
            
          </li>
        
      
    
      
        
          <li class="navigation-list-item">
            
            <a href="https://moor.simonbinder.eu/faq/" class="navigation-list-link">Frequently asked questions</a>
            
          </li>
        
      
    
      
        
          <li class="navigation-list-item">
            
            <a href="https://moor.simonbinder.eu/web" class="navigation-list-link">Web support</a>
            
          </li>
        
      
    
  </ul>
</nav>

      </div>
      <footer role="contentinfo" class="site-footer">
        <p class="text-small text-grey-dk-000 mb-0">This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.</p>
      </footer>
    </div>
    <div class="main-content-wrap js-main-content" tabindex="0">
      <div class="page-header">
        <div class="main-content">
          
          <div class="search js-search">
            <div class="search-input-wrap">
              <input type="text" class="js-search-input search-input" tabindex="0" placeholder="Search Moor" aria-label="Search Moor" autocomplete="off">
              <svg width="14" height="14" viewBox="0 0 28 28" xmlns="http://www.w3.org/2000/svg" class="search-icon"><title>Search</title><g fill-rule="nonzero"><path d="M17.332 20.735c-5.537 0-10-4.6-10-10.247 0-5.646 4.463-10.247 10-10.247 5.536 0 10 4.601 10 10.247s-4.464 10.247-10 10.247zm0-4c3.3 0 6-2.783 6-6.247 0-3.463-2.7-6.247-6-6.247s-6 2.784-6 6.247c0 3.464 2.7 6.247 6 6.247z"/><path d="M11.672 13.791L.192 25.271 3.02 28.1 14.5 16.62z"/></g></svg>
            </div>
            <div class="js-search-results search-results-wrap"></div>
          </div>
          
          
          <ul class="list-style-none text-small mt-md-1 mb-md-1 pb-4 pb-md-0 js-aux-nav aux-nav">
            <li><a href="https://pub.dartlang.org/packages/moor_flutter"><img src="https://img.shields.io/pub/v/moor_flutter.svg" /></a></li>
            <li><a href="https://github.com/simolus3/moor"><img src="https://img.shields.io/badge/repo-24292E.svg?logo=github&style=flat"></a></li>
          </ul> 
        </div>
      </div>
      <div class="main-content">
        
          
        
        <div id="main-content" class="page-content" role="main">
          
<span class="label label-green">Available from 1.1</span>


<h1 id="transactions">Transactions</h1>
<p>Moor has support for transactions and allows multiple queries to run atomically.
To begin a transaction, call the <code class="highlighter-rouge">transaction</code> method on your database or a DAO.
It takes a function as an argument that will be run on the transaction. In the
following example, which deals with deleting a category, we move all todo entries
in that category back to the default category:</p>
<div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Future</span> <span class="nf">deleteCategory</span><span class="p">(</span><span class="n">Category</span> <span class="n">category</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="n">transaction</span><span class="o">((</span><span class="n">t</span><span class="o">)</span> <span class="n">async</span> <span class="o">{</span>
    <span class="c1">// first, move the affected todo entries back to the default category</span>
    <span class="n">await</span> <span class="n">t</span><span class="o">.</span><span class="na">customUpdate</span><span class="o">(</span>
      <span class="s">'UPDATE todos SET category = NULL WHERE category = ?'</span><span class="o">,</span>
      <span class="nl">updates:</span> <span class="o">{</span><span class="n">todos</span><span class="o">},</span>
      <span class="nl">variables:</span> <span class="o">[</span><span class="n">Variable</span><span class="o">.</span><span class="na">withInt</span><span class="o">(</span><span class="n">category</span><span class="o">.</span><span class="na">id</span><span class="o">)],</span>
    <span class="o">);</span>

    <span class="c1">// then, delete the category</span>
    <span class="n">await</span> <span class="n">t</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">categories</span><span class="o">).</span><span class="na">delete</span><span class="o">(</span><span class="n">category</span><span class="o">);</span>
  <span class="o">});</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="️-gotchas">⚠️ Gotchas</h2>
<p>There are a couple of things that should be kept in mind when working with transactions:</p>
<ol>
  <li><strong>Await all calls</strong>: All queries inside the transaction must be <code class="highlighter-rouge">await</code>-ed. The transaction
  will complete when the inner method completes. Without <code class="highlighter-rouge">await</code>, some queries might be operating
  on the transaction after it has been closed!</li>
  <li><strong>Don’t run calls on your database</strong>: Inside a transaction function, all queries must
  be on the transaction itself.
    <div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">await</span> <span class="nf">transaction</span><span class="p">(</span><span class="o">(</span><span class="n">t</span><span class="o">)</span> <span class="n">async</span> <span class="o">{</span>
  <span class="c1">// BAD - this will run on the database itself!</span>
  <span class="n">await</span> <span class="n">delete</span><span class="o">(</span><span class="n">categories</span><span class="o">).</span><span class="na">delete</span><span class="o">(</span><span class="n">category</span><span class="o">);</span>
<span class="o">});</span>
<span class="n">await</span> <span class="nf">transaction</span><span class="p">(</span><span class="o">(</span><span class="n">t</span><span class="o">)</span> <span class="n">async</span> <span class="o">{</span>
  <span class="c1">// GOOD!</span>
  <span class="n">await</span> <span class="n">t</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">categories</span><span class="o">).</span><span class="na">delete</span><span class="o">(</span><span class="n">category</span><span class="o">);</span>
<span class="o">});</span>
</code></pre></div>    </div>
    <p>The reason behind this is that no calls can operate on the database while it’s in a transaction,
  they will run after the transaction has completed. When the completion of the transaction can only
  happen after a call to the database completes, as in the fist example, the database will reach a
  dead lock!</p>
  </li>
</ol>

<h2 id="transactions-and-query-streams">Transactions and query streams</h2>
<p>Query streams that have been created outside a transaction work nicely together with
updates made in a transaction: All changes to tables will only be reported after the
transaction completes. Updates inside a transaction don’t have an immediate effect on
streams.</p>

<p>However, streams cannot be created inside transactions! The reason behind that decision
is that it’s unclear what should happen to the stream after the transaction completes.
Should the stream complete as well? Begin to the updated data outside the transaction?
To not make things confusing here, this is forbidden.</p>


          

          <hr>
          <span class="fs-2">
              Was this page helpful? Please
              
              
              <a href="https://github.com/simolus3/moor/issues/new?body=Refers+to+the+documentation%3A+https%3A%2F%2Fmoor.simonbinder.eu%2Ftransactions">report an issue</a>
              if you have questions or run into problems.
          </span>
        </div>
      </div>
    </div>
  </div>

</body>
</html>
